#!/usr/bin/env ruby
require 'rubygems'
require 'sinatra-s3'

if ARGV.any? { |arg| %w(--version -v).any? { |flag| arg == flag } }
  puts "Sinatra-S3 #{S3::VERSION}"
  exit 0
end

app_path = ARGV.last
install_success = false

unless File.exists?(app_path)
  FileUtils.mkdir_p(app_path)

  config_ru = "require 'rubygems'\nrequire 'sinatra-s3'"
  if ARGV.any? { |arg| %w(--include-wiki --wiki).any? { |flag| arg == flag } }
    FileUtils.copy(File.join(S3::ROOT_DIR,"examples","wiki.rb"), File.join(app_path,"wiki.rb"))
    config_ru += "\nrequire 'wiki'"
  end
  config_ru += "\n\nuse S3::Tracker if defined?(RubyTorrent)\nuse S3::Admin\nrun S3::Application"
  File.open(File.join(app_path,"config.ru"),"w") { |f| f.write(config_ru) }

  File.open(File.join(app_path,"Rakefile"),"w") { |f| f.write("require 'sinatra-s3/tasks'") }
  FileUtils.copy(File.join(S3::ROOT_DIR,"s3.yml.example"), File.join(app_path,"s3.yml"))

  puts "Sinatra-S3 installed in #{app_path}."
else
  puts "Unable to install Sinatra-S3.  Install dir already exists."
end
